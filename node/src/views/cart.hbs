{{!-- Header --}}
<header class="header-v4">
    <!-- Header desktop -->
    <div class="container-menu-desktop">
        <!-- Topbar -->
        <div class="top-bar">
            <div class="content-topbar flex-sb-m h-full container">
                <div class="left-top-bar">
                    Free ship những hóa đơn trên 500.000đ
                </div>
            </div>
        </div>

        <div class="wrap-menu-desktop">
            <nav class="limiter-menu-desktop container">
                <!-- Menu desktop -->
                <div class="menu-desktop">
                    <ul class="main-menu">
                        <li>
                            <a class="font-weight-bold" href="/">TRANG
                                CHỦ</a>
                        </li>

                        <li>
                            <a class="font-weight-bold" href="/cart">GIỎ HÀNG</a>
                        </li>

                        <li>
                            <a class="font-weight-bold" href="/bill">ĐƠN HÀNG</a>
                        </li>
                    </ul>
                </div>

                <!-- Icon header -->
                <div class="wrap-icon-header flex-w flex-r-m">
                    <div
                        class="icon-header-item trans-04 p-l-22 p-r-11 js-show-modal-search hov-icon-header">
                        <i class="zmdi zmdi-search cltext"></i>
                    </div>

                    <div id="product-quantity-of-cart"
                        class="icon-header-item trans-04 p-l-22 p-r-11 icon-header-noti hov-icon-header js-show-cart"
                        data-notify="{{numberOfProductsInCart}}">
                        <i class="zmdi zmdi-shopping-cart cltext"></i>
                    </div>

                    <a href="#"
                        class="dis-block icon-header-item trans-04 hov-icon-header p-l-22 p-r-11 ">
                        <i class="zmdi zmdi-account-o cltext"></i>
                    </a>
                </div>
            </nav>
        </div>
    </div>

    <!-- Modal Search -->
    <div class="modal-search-header flex-c-m trans-04 js-hide-modal-search">
        <div class="container-search-header">
            <button class="flex-c-m btn-hide-modal-search trans-04 js-hide-modal-search">
                <img src="/image/icons/icon-close2.png" alt="CLOSE">
            </button>

            <form class="wrap-search-header flex-w p-l-15">
                <button class="flex-c-m trans-04">
                    <i class="zmdi zmdi-search"></i>
                </button>
                <input class="plh3" type="text" name="search" placeholder="Search...">
            </form>
        </div>
    </div>
</header>

<!-- Cart -->
<div class="wrap-header-cart js-panel-cart">
    <div class="s-full js-hide-cart"></div>

    <div class="header-cart flex-col-l p-l-65 p-r-25">
        <div class="header-cart-title flex-w flex-sb-m p-b-8">
            <span class="mtext-103 cl8">Giỏ hàng</span>

            <div class="fs-35 lh-10 cl2 p-lr-5 pointer hov-cl1 trans-04 js-hide-cart">
                <i class="zmdi zmdi-close"></i>
            </div>
        </div>

        <div class="header-cart-content flex-w js-pscroll">
            <ul id="list-products-in-cart-sidebar" class="header-cart-wrapitem w-full">
                {{#each listProductsInCart}}
                <li class="header-cart-item flex-w flex-t m-b-12 align-items-center">
                    <div class="header-cart-item-img">
                        <img src="https://localhost:44330/public/image/{{this.Product.image}}"
                            alt="IMG" />
                    </div>

                    <div class="header-cart-item-txt p-t-8">
                        <a href="/{{this.Product.slug}}"
                            class="header-cart-item-name m-b-8 hov-cl1 trans-04">
                            {{this.Product.name}}
                        </a>

                        <span class="header-cart-item-info" style="color: #D70018;">
                            {{getCurrentPrice
                            this.Product.price this.Product.discount}}
                        </span>
                    </div>
                </li>
                {{else}}
                Giỏ hàng trống
                {{/each}}
            </ul>
            <div class="w-full">
                <div class="header-cart-total w-full p-tb-40">
                    Tổng: <span id="cart-total-price-sidebar"
                        style="color: #D70018;">{{getCurrentPrice totalCartPrice 0}}</span>
                </div>

                <div class="header-cart-buttons flex-w w-full justify-content-center">
                    <a href="/cart"
                        class="flex-c-m stext-101 cl0 size-107 bg3 bor2 hov-btn3 p-lr-15 trans-04 m-r-8 m-b-10">
                        Đi đến giỏ hàng
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Shoping Cart -->
<form class="bg0 p-t-75 p-b-85">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 col-xl-10 m-lr-auto m-b-50">
                <div class="m-l-25 m-r--38 m-lr-0-xl">
                    <div class="wrap-table-shopping-cart">
                        <table id="list-cart-detail-items" class="table-shopping-cart">
                            {{#each listProductsInCart}}
                            <tr data-product-id="{{this.Product.id}}"
                                data-product-price="{{this.price}}" data-cart-item-id="{{this.id}}"
                                class="table_row">
                                <td class="column-1">
                                    <div class="how-itemcart1">
                                        <img src="https://localhost:44330/public/image/{{this.Product.image}}"
                                            alt="IMG">
                                    </div>
                                </td>
                                <td class=" pr-2">{{this.Product.name}}</td>
                                <td data-product-price={{getCurrentPriceNumber this.Product.price
                                    this.Product.discount}} class="column-3"
                                    style="color: #D70018;">{{getCurrentPrice
                                    this.Product.price this.Product.discount}}</td>
                                <td class="column-4">
                                    <div class="wrap-num-product flex-w m-l-auto m-r-0">
                                        <div
                                            class="btn-num-product-down cl8 hov-btn3 trans-04 flex-c-m">
                                            <i class="fs-16 zmdi zmdi-minus"></i>
                                        </div>

                                        <input class="mtext-104 cl3 txt-center num-product"
                                            type="number" name="num-product1" value="1" min="1">

                                        <div
                                            class="btn-num-product-up cl8 hov-btn3 trans-04 flex-c-m">
                                            <i class="fs-16 zmdi zmdi-plus"></i>
                                        </div>
                                    </div>
                                </td>
                                <td class="column-5"><button data-cart-detail-id="{{this.id}}"
                                        data-toggle="modal" data-target="#confirm-delete-modal"
                                        data-cart-detail-id="{{this.id}}" type="button"
                                        data-cart-detail-product-name="{{this.Product.name}}"
                                        type="button" style="color: #D70018;"
                                        class="detete-product-in-cart-btn">Xóa</button>
                                </td>
                            </tr>
                            {{else}}
                            <h4>Giỏ hàng trống</h4>
                            {{/each}}
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {{#if (isNotCartEmpty numberOfProductsInCart)}}
        <div id="bill-information" class="row">
            <div class="col-lg-12 col-xl-10  m-lr-auto m-b-50">
                <div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
                    <h4 class="mtext-109 cl8 p-b-30">
                        Đơn hàng
                    </h4>
                    <div class="flex-w flex-t bor12 p-t-15 p-b-30">
                        <div class="size-208 w-full-ssm">
                            <span class="stext-110 cl8">
                                Thông tin nhận hàng:
                            </span>
                        </div>

                        <div class="size-209 p-r-18 p-r-0-sm w-full-ssm">
                            <div class="">
                                <div class="form-group">
                                    <label for="">Tên người nhận</label>
                                    <input id="bill-recipient-name" type="text"
                                        class="form-control">
                                </div>

                                <div class="form-group">
                                    <label for="">Số điện thoại</label>
                                    <input id="bill-recipient-phone" type="text"
                                        class="form-control">
                                </div>

                                <div class="form-group">
                                    <label for="">Địa chỉ</label>
                                    <input id="bill-recipient-address" type="text"
                                        class="form-control">
                                </div>

                                <div class="form-group">
                                    <label for="">Ghi chú</label>
                                    <input id="bill-note" type="text" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex-w flex-t p-t-27 p-b-33">
                        <div class="size-208">
                            <span class="mtext-101 cl8">
                                Tổng đơn hàng:
                            </span>
                        </div>

                        <div class="size-209 p-t-1">
                            <span id="bill-total-price" class="mtext-110 cl8"
                                style="color: #D70018;">
                                {{getCurrentPrice totalCartPrice 0}}
                            </span>
                        </div>
                    </div>

                    <button type="button"
                        class="flex-c-m stext-101 cl0 size-117 mx-auto bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer"
                        onclick="createBill()">
                        Đặt hàng
                    </button>
                </div>
            </div>
        </div>
        {{/if}}
    </div>
</form>

<!-- Modal -->
<div class="modal fade" id="confirm-delete-modal" tabindex="-1" role="dialog" aria-hidden="true"
    style="z-index: 9999">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title cl8" id="exampleModalLabel">Bỏ sản phẩm</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body cl8">
                Bạn chắc chắn muốn bỏ sản phẩm <strong
                    id="confirm-detele-modal-product-name"></strong> khỏi
                giỏ hàng?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Hủy bỏ</button>
                <button id="confirm-delete-modal-agree-btn" data-cart-detail-id="" type="button"
                    class="btn btn-danger">Đồng ý</button>
            </div>
        </div>
    </div>
</div>

<script>
    // NHẤN NÚT ĐẶT HÀNG
    function createBill() {
        const billRecipientNameValue = document.getElementById("bill-recipient-name").value;
        const billRecipientPhoneValue = document.getElementById("bill-recipient-phone").value;
        const billRecipientAddressValue = document.getElementById("bill-recipient-address").value;
        const billNoteValue = document.getElementById("bill-note").value;

        const listAllCartItem = Array.from(document.querySelectorAll("#list-cart-detail-items tr"));
        var totalPrice = 0;
        listAllCartItem.forEach(item => {
            const itemPrice = parseInt(item.querySelector(".column-3").dataset.productPrice);
            const productQuantity = parseInt(item.querySelector(".num-product").value);
            totalPrice += itemPrice * productQuantity;
        });

        const data = {
            "recipientName": billRecipientNameValue,
            "recipientAddress": billRecipientAddressValue,
            "recipientPhone": billRecipientPhoneValue,
            "status": 0,
            "createdAt": new Date().toLocaleDateString(),
            "note": billNoteValue,
            "totalPrice": totalPrice
        }
        fetch("https://localhost:44330/api/bill", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(billObject => {
                const billId = billObject.id;

                // Call api to get all products in cart
                const listAllCartItem = Array.from(document.querySelectorAll("#list-cart-detail-items tr"));
                listAllCartItem.forEach(cartItem => {
                    // call api để thêm vào bill detail và xóa khỏi cart
                    async function addBillDetails(url = "", newBillDetail = {}) {
                        const response = await fetch(url, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(newBillDetail)
                        });
                        return response.json();
                    }

                    async function removeAllProductsInCart(url = "") {
                        const response = await fetch(url, {
                            method: "DELETE",
                            headers: {
                                "Content-Type": "application/json",
                            }
                        });
                        return response.json();
                    }

                    const newBillDetail = {
                        billId: billId,
                        productId: cartItem.dataset.productId,
                        quantity: parseInt(cartItem.querySelector(".num-product").value),
                        price: cartItem.dataset.productPrice
                    }

                    const cartItemId = parseInt(cartItem.dataset.cartItemId);

                    Promise.all([addBillDetails("https://localhost:44330/api/billdetail", newBillDetail),
                    removeAllProductsInCart(`https://localhost:44330/api/cart?id=${cartItemId}`)])
                        .then(results => {
                            // console.log(">>> Bill detail item: ", results[0]);
                            // console.log(">>> Cart detail item: ", results[1]);
                            window.location.href = "/bill";
                        })
                        .catch(error => console.log(error));
                })
            })
            .catch(error => console.log(">>> Có lỗi khi tạo đơn hàng: ", error))
    }

    // Function to re render list all product in cart (right sidebar)
    function reRenderProductsInCartSidebar() {
        const listProductsInCartSidebar = document.getElementById("list-products-in-cart-sidebar");
        var totalPrice = 0;
        fetch("https://localhost:44330/api/cart")
            .then(res => res.json())
            .then(listItems => {
                if (listItems.length == 0) {
                    listProductsInCartSidebar.innerHTML = "Giỏ hàng trống";
                    document.getElementById("cart-total-price-sidebar").innerHTML = parseInt(0).toLocaleString("vi-VN", {
                        style: "currency",
                        currency: "VND",
                    });
                } else {
                    const html = listItems.map(item => {
                        totalPrice += parseInt(item.price);
                        const price = parseInt(item.price).toLocaleString("vi-VN", {
                            style: "currency",
                            currency: "VND",
                        });
                        return `
                            <li class="header-cart-item flex-w flex-t m-b-12 align-items-center">
                                <div class="header-cart-item-img">
                                    <img src="https://localhost:44330/public/image/${item.Product.image}"
                                        alt="IMG" />
                                </div>

                                <div class="header-cart-item-txt p-t-8">
                                    <a href="/${item.Product.slug}"
                                        class="header-cart-item-name m-b-8 hov-cl1 trans-04">
                                        ${item.Product.name}
                                    </a>

                                    <span class="header-cart-item-info" style="color: #D70018;">
                                        ${price}
                                    </span>
                                </div>
                            </li>
                        `;
                    });
                    listProductsInCartSidebar.innerHTML = html.join("");
                    document.getElementById("cart-total-price-sidebar").innerHTML = parseInt(totalPrice).toLocaleString("vi-VN", {
                        style: "currency",
                        currency: "VND",
                    });
                    document.getElementById("bill-total-price").innerHTML = parseInt(totalPrice).toLocaleString("vi-VN", {
                        style: "currency",
                        currency: "VND",
                    });
                }
            })
    }

    // Click agree remove button
    if (document.getElementById("confirm-delete-modal-agree-btn")) {
        document
            .getElementById("confirm-delete-modal-agree-btn")
            .addEventListener("click", (e) => {
                const cartDetailId = parseInt(e.target.dataset.cartDetailId);
                fetch(`https://localhost:44330/api/cart?id=${cartDetailId}`, {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json",
                    },
                })
                    .then((res) => res.json())
                    .then((cartItemIdDeleted) => {
                        console.log(
                            "Cart detail deleted id: ",
                            cartItemIdDeleted
                        ); // cart item id đã xóa
                        $("#confirm-delete-modal").modal("hide");
                        // Re render số lượng sp trong giỏ hàng
                        document.getElementById(
                            "product-quantity-of-cart"
                        ).dataset.notify =
                            parseInt(
                                document.getElementById(
                                    "product-quantity-of-cart"
                                ).dataset.notify
                            ) - 1;

                        // Re render lại danh sách sản phẩm trong giỏ hàng
                        const listAllCartItem = Array.from(
                            document.querySelectorAll(
                                "#list-cart-detail-items tr"
                            )
                        );
                        Array.from(listAllCartItem).forEach((cartItem) => {
                            const cartItemId = parseInt(
                                cartItem.dataset.cartItemId
                            );
                            if (
                                cartItemId === cartItemIdDeleted
                            ) {
                                cartItem.remove();
                            }
                        });
                        if (Array.from(document.querySelectorAll(
                            "#list-cart-detail-items tr"
                        )).length === 0) {
                            document.getElementById("list-cart-detail-items").innerHTML =
                                "<h4>Giỏ hàng trống</h4>";
                            document.getElementById(
                                "bill-information"
                            ).innerHTML = "";
                        }
                        reRenderProductsInCartSidebar();
                    })
                    .catch((error) =>
                        console.log(">>> error when remove product from cart")
                    );
            });
    }
</script>